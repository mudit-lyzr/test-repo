name: PR Chat Hook

on:
  pull_request:
    types:
      - opened

jobs:
  send-to-lyzr:
    runs-on: ubuntu-latest
    steps:
      - name: Call Lyzr chat endpoint with PR context (JavaScript)
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.LYZRAPI }}
          USER_ID: ${{ secrets.LYZR_USER_ID }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          PAT_TOKEN: ${{ secrets.PAT }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const required = ["API_KEY", "USER_ID", "AGENT_ID", "PAT_TOKEN", "OWNER", "REPO", "PR_NUMBER"];
            for (const name of required) {
              if (!process.env[name]) {
                core.setFailed(`Missing required env: ${name}`);
                return;
              }
            }

            // Create a session before calling the agent
            const sessionRes = await fetch("https://agent-prod.studio.lyzr.ai/v1/sessions/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-api-key": process.env.API_KEY,
              },
              body: JSON.stringify({
                user_id: process.env.USER_ID,
                agent_id: process.env.AGENT_ID,
                metadata: {},
              }),
            });

            if (!sessionRes.ok) {
              const body = await sessionRes.text();
              core.setFailed(`Session creation failed: ${sessionRes.status} ${sessionRes.statusText} - ${body}`);
              return;
            }

            let sessionData;
            try {
              sessionData = await sessionRes.json();
            } catch (err) {
              core.setFailed(`Failed to parse session response JSON: ${err.message}`);
              return;
            }

            const sessionId = sessionData?.session_id ?? sessionData?.sessionId ?? sessionData?.id;
            if (!sessionId) {
              core.setFailed("Session response missing session id");
              return;
            }

            const message = `pull request no ${process.env.PR_NUMBER}, owner ${process.env.OWNER}, repo name:${process.env.REPO}`;

            const response = await fetch("https://agent-prod.studio.lyzr.ai/v3/inference/chat/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-api-key": process.env.API_KEY,
              },
              body: JSON.stringify({
                user_id: process.env.USER_ID,
                agent_id: process.env.AGENT_ID,
                session_id: sessionId,
                message,
              }),
            });

            if (!response.ok) {
              const body = await response.text();
              core.setFailed(`API request failed: ${response.status} ${response.statusText} - ${body}`);
              return;
            }

            let data;
            try {
              data = await response.json();
            } catch (err) {
              core.setFailed(`Failed to parse API response JSON: ${err.message}`);
              return;
            }

            const lyzrResponse = data?.response;
            if (!lyzrResponse) {
              core.setFailed("API response missing 'response' key");
              return;
            }

            // Use a distinct name to avoid clashing with github-script's injected octokit
            const token = process.env.PAT_TOKEN;
            const patOctokit = github.getOctokit(token);

            await patOctokit.rest.pulls.update({
              owner: process.env.OWNER,
              repo: process.env.REPO,
              pull_number: Number(process.env.PR_NUMBER),
              body: lyzrResponse,
            });

